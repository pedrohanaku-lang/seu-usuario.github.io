<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const W = 800, H = 600;
const PLAYER_SIZE = 28;

let player,enemies,playerBullets,enemyBullets;
let keys={},mouse={x:400,y:300};

let gameActive=false,showingCards=false,gameOverFlag=false;

let stage=1;
let score=0;
let kills=0;

let maxLives=3,lives=3;

let doubleShot=false;
let swordRange=70;

let swordCooldown=0;
let shootCooldown=0;

let phase="wave"; // wave | boss | cards

/* ---------------- MENU ---------------- */

function startGame(){
    document.getElementById("menu").style.display="none";
    document.getElementById("creditos").style.display="none";
    canvas.style.display="block";
    resetRun();
    gameActive=true;
}

/* ------------- RESET ------------- */

function resetRun(){

    player={x:400,y:300,speed:4};

    enemies=[];
    playerBullets=[];
    enemyBullets=[];

    stage=1;
    score=0;
    kills=0;

    maxLives=3;
    lives=3;

    doubleShot=false;
    swordRange=70;

    swordCooldown=0;
    shootCooldown=0;

    phase="wave";

    gameOverFlag=false;
    showingCards=false;

    spawnWave();
}

/* ---------------- INPUT ---------------- */

window.addEventListener("keydown",e=>{
    keys[e.key.toLowerCase()]=true;

    if(e.key.toLowerCase()==="r" && gameOverFlag){
        canvas.style.display="none";
        document.getElementById("menu").style.display="block";
    }
});
window.addEventListener("keyup",e=>{
    keys[e.key.toLowerCase()]=false;
});

canvas.oncontextmenu=e=>e.preventDefault();
canvas.addEventListener("mousemove",e=>{
    let r=canvas.getBoundingClientRect();
    mouse.x=e.clientX-r.left;
    mouse.y=e.clientY-r.top;
});
canvas.addEventListener("mousedown",e=>{
    if(e.button===2 && gameActive) shoot();
});

/* ---------------- CLASSES ---------------- */

class Bullet{
    constructor(x,y,tx,ty,s,c){
        this.x=x;this.y=y;
        let dx=tx-x,dy=ty-y;
        let d=Math.hypot(dx,dy)||1;
        this.vx=dx/d*s;
        this.vy=dy/d*s;
        this.c=c;
    }
    update(){this.x+=this.vx;this.y+=this.vy;}
    draw(){
        ctx.fillStyle=this.c;
        ctx.fillRect(this.x-4,this.y-4,8,8);
    }
    off(){return this.x<-20||this.x>W+20||this.y<-20||this.y>H+20;}
}

/* ---------------- PLAYER ---------------- */

function shoot(){
    if(shootCooldown>0) return;

    fireBullet();

    if(doubleShot) setTimeout(fireBullet,60);

    shootCooldown=12;
}

function fireBullet(){
    playerBullets.push(new Bullet(
        player.x+PLAYER_SIZE/2,
        player.y+PLAYER_SIZE/2,
        mouse.x,mouse.y,7,"#f44"
    ));
}

function sword(){

    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i];
        let d=Math.hypot(
            e.x+e.w/2-(player.x+PLAYER_SIZE/2),
            e.y+e.h/2-(player.y+PLAYER_SIZE/2)
        );
        if(d<swordRange){
            hitEnemy(i);
            break;
        }
    }

    for(let i=enemyBullets.length-1;i>=0;i--){
        let b=enemyBullets[i];
        let d=Math.hypot(
            b.x-(player.x+PLAYER_SIZE/2),
            b.y-(player.y+PLAYER_SIZE/2)
        );
        if(d<swordRange){
            enemyBullets.splice(i,1);
        }
    }
}

/* ---------------- SPAWN ---------------- */

function spawnEnemy(){
    enemies.push({
        x:Math.random()*(W-28),
        y:Math.random()*(H-28),
        w:28,h:28,
        vx:Math.random()*2-1,
        vy:Math.random()*2-1,
        shootTimer:0,
        shootInterval:70
    });
}

function spawnBoss(){

    enemies.push({
        x:W/2-90,y:40,
        w:180,h:180,
        vx:1.2,vy:1,
        shootTimer:0,
        shootInterval:20,
        isBoss:true,
        maxHp:120+stage*40,
        hp:120+stage*40
    });

    phase="boss";
}

function spawnWave(){
    phase="wave";
    for(let i=0;i<4+stage;i++) spawnEnemy();
}

/* ---------------- HIT / KILL ---------------- */

function hitEnemy(i){

    let e=enemies[i];

    if(e.isBoss){
        e.hp--;
        if(e.hp<=0){
            killEnemy(i);
        }
        return;
    }

    killEnemy(i);
}

function killEnemy(i){

    let e=enemies.splice(i,1)[0];
    kills++;

    if(!e.isBoss){
        score+=10;

        if(phase==="wave" && enemies.length===0){
            spawnBoss();
        }
        return;
    }

    // boss morreu
    openCards();

    setTimeout(()=>{
        stage++;
        spawnWave();
    },200);
}

/* ---------------- CARDS ---------------- */

function openCards(){

    showingCards=true;
    gameActive=false;

    const div=document.getElementById("cartas");
    div.innerHTML="";
    div.style.display="flex";

    const pool=[
        {t:"+1 vida mÃ¡xima",f:()=>{maxLives++;lives++;}},
        {t:"Tiro duplo",f:()=>{doubleShot=true;}},
        {t:"Espada maior",f:()=>{swordRange+=25;}},
        {t:"Velocidade +",f:()=>{player.speed+=0.6;}}
    ];

    shuffle(pool);

    for(let i=0;i<3;i++){
        let d=document.createElement("div");
        d.className="cartao";
        d.textContent=pool[i].t;
        d.onclick=()=>{
            pool[i].f();
            div.style.display="none";
            showingCards=false;
            gameActive=true;
        };
        div.appendChild(d);
    }
}

function shuffle(a){
    for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
}

/* ---------------- UPDATE ---------------- */

function update(){

    if(!gameActive) return;

    if(shootCooldown>0) shootCooldown--;
    if(swordCooldown>0) swordCooldown--;

    if(keys[" "] && swordCooldown===0){
        sword();
        swordCooldown=25;
    }

    if(keys["w"]) player.y-=player.speed;
    if(keys["s"]) player.y+=player.speed;
    if(keys["a"]) player.x-=player.speed;
    if(keys["d"]) player.x+=player.speed;

    player.x=Math.max(0,Math.min(W-PLAYER_SIZE,player.x));
    player.y=Math.max(0,Math.min(H-PLAYER_SIZE,player.y));

    enemies.forEach(e=>{

        e.x+=e.vx;
        e.y+=e.vy;

        if(e.x<0||e.x+e.w>W) e.vx*=-1;
        if(e.y<0||e.y+e.h>H) e.vy*=-1;

        e.shootTimer++;

        if(e.shootTimer>=e.shootInterval){

            if(e.isBoss){

                let cx=e.x+e.w/2;
                let cy=e.y+e.h/2;

                for(let k=0;k<12;k++){
                    let a=k*Math.PI*2/12;
                    enemyBullets.push(new Bullet(
                        cx,cy,
                        cx+Math.cos(a)*300,
                        cy+Math.sin(a)*300,
                        4,"#f0f"
                    ));
                }

            }else{
                enemyBullets.push(new Bullet(
                    e.x+e.w/2,e.y+e.h/2,
                    player.x+PLAYER_SIZE/2,
                    player.y+PLAYER_SIZE/2,
                    4.5,"#44f"
                ));
            }

            e.shootTimer=0;
        }

    });

    updateBullets(playerBullets,true);
    updateBullets(enemyBullets,false);
}

/* ---------------- BULLETS ---------------- */

function updateBullets(arr,isPlayer){

    for(let i=arr.length-1;i>=0;i--){

        let b=arr[i];
        b.update();

        if(b.off()){
            arr.splice(i,1);
            continue;
        }

        if(!isPlayer){
            let d=Math.hypot(
                b.x-(player.x+PLAYER_SIZE/2),
                b.y-(player.y+PLAYER_SIZE/2)
            );
            if(d<14){
                arr.splice(i,1);
                lives--;
                if(lives<=0) gameOver();
            }
        }else{
            for(let j=enemies.length-1;j>=0;j--){
                let e=enemies[j];
                let d=Math.hypot(
                    b.x-(e.x+e.w/2),
                    b.y-(e.y+e.h/2)
                );
                if(d<18){
                    arr.splice(i,1);
                    hitEnemy(j);
                    break;
                }
            }
        }
    }
}

/* ---------------- GAME OVER ---------------- */

function gameOver(){
    gameActive=false;
    gameOverFlag=true;
}

/* ---------------- DRAW ---------------- */

function draw(){

    ctx.clearRect(0,0,W,H);

    ctx.fillStyle="#0f0";
    ctx.fillRect(player.x,player.y,PLAYER_SIZE,PLAYER_SIZE);

    enemies.forEach(e=>{
        ctx.fillStyle=e.isBoss?"#600":"#f0f";
        ctx.fillRect(e.x,e.y,e.w,e.h);

        if(e.isBoss){
            let bw=e.w*(e.hp/e.maxHp);
            ctx.fillStyle="#fff";
            ctx.fillRect(e.x,e.y-10,e.w,6);
            ctx.fillStyle="red";
            ctx.fillRect(e.x,e.y-10,bw,6);
        }
    });

    playerBullets.forEach(b=>b.draw());
    enemyBullets.forEach(b=>b.draw());

    ctx.fillStyle="#0f0";
    ctx.fillText("Fase: "+stage,10,18);
    ctx.fillText("Vidas: "+lives+"/"+maxLives,10,34);
    ctx.fillText("Kills: "+kills,10,50);
    ctx.fillText("Score: "+score,10,66);

    if(gameOverFlag){
        ctx.fillStyle="rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle="red";
        ctx.font="40px Arial";
        ctx.fillText("GAME OVER",W/2-120,H/2);
        ctx.font="18px Arial";
        ctx.fillText("Pressione R para voltar ao menu",W/2-150,H/2+30);
    }
}

/* ---------------- LOOP ---------------- */

function loop(){
    requestAnimationFrame(loop);
    update();
    draw();
}

loop();
</script>


