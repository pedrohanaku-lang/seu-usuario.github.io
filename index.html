<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Samurai Rogue</title>
<style>
body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh}
canvas{background:#111;border:2px solid #0f0}
</style>
</head>
<body>
<canvas id="c" width="900" height="600"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const W=900,H=600;

let mouse={x:0,y:0,down:false};

let player;
let enemies=[];
let bullets=[];
let enemyBullets=[];
let allies=[];

let ult=0;
let maxUlt=100;
let usingUlt=false;
let ultTimer=0;

const sword = {
    angle:0,
    len:80,
    width:10,
    active:false,
};

canvas.addEventListener("mousemove",e=>{
    const r=canvas.getBoundingClientRect();
    mouse.x=e.clientX-r.left;
    mouse.y=e.clientY-r.top;
});

canvas.addEventListener("mousedown",e=>{
    if(e.button===0) mouse.down=true;
});
canvas.addEventListener("mouseup",e=>{
    if(e.button===0) mouse.down=false;
});

let keys={};
window.addEventListener("keydown",e=>{
    keys[e.key.toLowerCase()]=true;

    if(e.key.toLowerCase()==="g" && ult>=maxUlt && !usingUlt){
        usingUlt=true;
        ultTimer=30;
        ult=0;
    }
});
window.addEventListener("keyup",e=>{
    keys[e.key.toLowerCase()]=false;
});

function reset(){
    player={x:450,y:300,r:18,speed:4,hp:5};

    enemies=[];
    bullets=[];
    enemyBullets=[];
    allies=[];

    spawnWave();

    ult=0;
}

function spawnWave(){
    for(let i=0;i<4;i++) spawnEnemy("shooter");
    spawnEnemy("dasher");
    spawnBoss();
}

function spawnEnemy(type){
    let e={
        x:Math.random()*W,
        y:Math.random()*H,
        r:16,
        type,
        hp:type==="dasher"?4:3,
        t:0
    };
    enemies.push(e);
}

function spawnBoss(){
    enemies.push({
        x:W/2,
        y:120,
        w:160,
        h:120,
        isBoss:true,
        hp:120,
        t:0
    });
}

function spawnAlly(){
    allies.push({
        x:player.x+30,
        y:player.y,
        t:0
    });
}

function shootEnemy(e){
    enemyBullets.push({
        x:e.x,
        y:e.y,
        vx:(player.x-e.x)/40,
        vy:(player.y-e.y)/40
    });
}

function update(){

    // player
    if(keys.a) player.x-=player.speed;
    if(keys.d) player.x+=player.speed;
    if(keys.w) player.y-=player.speed;
    if(keys.s) player.y+=player.speed;

    player.x=Math.max(20,Math.min(W-20,player.x));
    player.y=Math.max(20,Math.min(H-20,player.y));

    // sword follow mouse while holding
    sword.active = mouse.down;

    if(sword.active){
        sword.angle=Math.atan2(mouse.y-player.y,mouse.x-player.x);
        checkSwordHits();
    }

    // enemies
    for(let e of enemies){

        e.t++;

        if(e.isBoss){
            if(e.t%25===0){
                for(let a=0;a<Math.PI*2;a+=Math.PI/6){
                    enemyBullets.push({
                        x:e.x,
                        y:e.y,
                        vx:Math.cos(a)*4,
                        vy:Math.sin(a)*4
                    });
                }
            }
        }else if(e.type==="shooter"){
            if(e.t%60===0) shootEnemy(e);
        }else if(e.type==="dasher"){
            let dx=player.x-e.x;
            let dy=player.y-e.y;
            let d=Math.hypot(dx,dy)||1;
            e.x+=dx/d*2.5;
            e.y+=dy/d*2.5;
        }
    }

    // enemy bullets
    for(let b of enemyBullets){
        b.x+=b.vx;
        b.y+=b.vy;
    }

    // allies
    for(let a of allies){
        a.t++;
        a.x+= (player.x-a.x)*0.05;
        a.y+= (player.y-a.y)*0.05;

        if(a.t%40===0){
            bullets.push({
                x:a.x,
                y:a.y,
                vx:(nearestEnemyX(a)-a.x)/25,
                vy:(nearestEnemyY(a)-a.y)/25
            });
        }
    }

    // player bullets
    for(let b of bullets){
        b.x+=b.vx;
        b.y+=b.vy;
    }

    updateCollisions();

    // ultimate
    if(usingUlt){
        ultTimer--;
        if(ultTimer<=0) usingUlt=false;
    }

}

function nearestEnemyX(a){
    if(enemies.length===0) return a.x;
    return enemies[0].x;
}
function nearestEnemyY(a){
    if(enemies.length===0) return a.y;
    return enemies[0].y;
}

// real sword segment collision
function checkSwordHits(){

    let x1=player.x;
    let y1=player.y;
    let x2=player.x+Math.cos(sword.angle)*sword.len;
    let y2=player.y+Math.sin(sword.angle)*sword.len;

    // enemies
    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i];

        if(e.isBoss){
            if(lineRect(x1,y1,x2,y2,e.x-e.w/2,e.y-e.h/2,e.w,e.h)){
                e.hp--;
                gainUlt(2);
            }
        }else{
            let d=distToSegment(e.x,e.y,x1,y1,x2,y2);
            if(d<e.r){
                e.hp--;
                gainUlt(2);
            }
        }

        if(e.hp<=0) enemies.splice(i,1);
    }

    // bullets cut
    for(let i=enemyBullets.length-1;i>=0;i--){
        let b=enemyBullets[i];
        let d=distToSegment(b.x,b.y,x1,y1,x2,y2);
        if(d<6){
            if(Math.random()<0.3){
                enemyBullets.splice(i,1);
                gainUlt(1);
            }
        }
    }

}

function gainUlt(v){
    ult=Math.min(maxUlt,ult+v);
}

function updateCollisions(){

    // ult hit
    if(usingUlt){
        for(let i=enemies.length-1;i>=0;i--){
            enemies[i].hp-=2;
            if(enemies[i].hp<=0) enemies.splice(i,1);
        }
        enemyBullets=[];
    }

    // bullets hit enemies
    for(let i=bullets.length-1;i>=0;i--){
        let b=bullets[i];
        for(let j=enemies.length-1;j>=0;j--){
            let e=enemies[j];
            let d=Math.hypot(b.x-e.x,b.y-e.y);
            if(d<20){
                e.hp--;
                bullets.splice(i,1);
                if(e.hp<=0) enemies.splice(j,1);
                break;
            }
        }
    }

}

// helpers
function distToSegment(px,py,x1,y1,x2,y2){
    const l2=(x2-x1)**2+(y2-y1)**2;
    if(l2===0) return Math.hypot(px-x1,py-y1);
    let t=((px-x1)*(x2-x1)+(py-y1)*(y2-y1))/l2;
    t=Math.max(0,Math.min(1,t));
    const x=x1+t*(x2-x1);
    const y=y1+t*(y2-y1);
    return Math.hypot(px-x,py-y);
}

function lineRect(x1,y1,x2,y2,rx,ry,rw,rh){
    return lineLine(x1,y1,x2,y2,rx,ry,rx+rw,ry) ||
           lineLine(x1,y1,x2,y2,rx,ry,rx,ry+rh) ||
           lineLine(x1,y1,x2,y2,rx+rw,ry,rx+rw,ry+rh) ||
           lineLine(x1,y1,x2,y2,rx,ry+rh,rx+rw,ry+rh);
}

function lineLine(x1,y1,x2,y2,x3,y3,x4,y4){
    const uA=((x4-x3)*(y1-y3)-(y4-y3)*(x1-x3))/((y4-y3)*(x2-x1)-(x4-x3)*(y2-y1));
    const uB=((x2-x1)*(y1-y3)-(y2-y1)*(x1-x3))/((y4-y3)*(x2-x1)-(x4-x3)*(y2-y1));
    return uA>=0&&uA<=1&&uB>=0&&uB<=1;
}

function draw(){

    ctx.clearRect(0,0,W,H);

    // player
    ctx.fillStyle="#0f0";
    ctx.beginPath();
    ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
    ctx.fill();

    // sword
    if(sword.active){
        ctx.strokeStyle="yellow";
        ctx.lineWidth=sword.width;
        ctx.beginPath();
        ctx.moveTo(player.x,player.y);
        ctx.lineTo(
            player.x+Math.cos(sword.angle)*sword.len,
            player.y+Math.sin(sword.angle)*sword.len
        );
        ctx.stroke();
    }

    // enemies
    for(let e of enemies){
        if(e.isBoss){
            ctx.fillStyle="#800";
            ctx.fillRect(e.x-e.w/2,e.y-e.h/2,e.w,e.h);
        }else{
            ctx.fillStyle=e.type==="dasher"?"#f33":"#f0f";
            ctx.beginPath();
            ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
            ctx.fill();
        }
    }

    // bullets
    ctx.fillStyle="#f44";
    for(let b of bullets) ctx.fillRect(b.x-2,b.y-2,4,4);

    ctx.fillStyle="#4af";
    for(let b of enemyBullets) ctx.fillRect(b.x-3,b.y-3,6,6);

    // allies
    ctx.fillStyle="#0ff";
    for(let a of allies){
        ctx.beginPath();
        ctx.arc(a.x,a.y,10,0,Math.PI*2);
        ctx.fill();
    }

    // ult bar
    ctx.fillStyle="#fff";
    ctx.fillRect(20,20,200,10);
    ctx.fillStyle="#ff0";
    ctx.fillRect(20,20,200*(ult/maxUlt),10);

    if(usingUlt){
        ctx.strokeStyle="#ff0";
        ctx.lineWidth=8;
        ctx.beginPath();
        ctx.moveTo(0,H/2);
        ctx.lineTo(W,H/2);
        ctx.stroke();
    }

}

function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}

// bÃ´nus: ganhar NPC aliado apertando H (upgrade exemplo)
window.addEventListener("keydown",e=>{
    if(e.key.toLowerCase()==="h"){
        spawnAlly();
    }
});

reset();
loop();
</script>
</body>
</html>
