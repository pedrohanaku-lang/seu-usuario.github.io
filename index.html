<!DOCTYPE html>
<html>
<head>
    <title>Time Zueira RPG - Final Fix</title>
    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
    </style>
</head>
<body>
<script>
// 1. Inicialização do Motor
kaboom({
    scale: 3,
    background: [0, 0, 0],
    crisp: true,
})

// 2. Carregamento dos Assets (Imagens enviadas)
loadSprite("logo_vmz", "image_da3f41.png");
loadSprite("logo_tz", "image_da46a4.png");
loadSprite("hero_spectral", "_Hugkw.gif"); 
loadSprite("samurai_hat", "40vMaR.gif");   
loadSprite("ninja_green", "Ru5PS2.gif");   
loadSprite("old_master", "XSuwrQ.gif");    
loadSprite("wizard", "KFBLh9.gif");        
loadSprite("samurai_red", "sRNxiP.gif");   

// Tileset padrão do Kaboom para o chão e paredes
loadSpriteAtlas("https://kaboomjs.com/sprites/dungeon.png", {
    "floor": { x: 16, y: 64, width: 48, height: 48, sliceX: 3, sliceY: 3 },
    "wall": { x: 16, y: 16, width: 16, height: 16 },
    "wall_top": { x: 16, y: 0, width: 16, height: 16 },
});

scene("game", () => {
    // Camadas de renderização
    const LAYERS = { bg: -1, game: 0, ui: 1 };
    const setLayer = (l) => z(LAYERS[l]);

    // 3. Definição das Armas
    const weapons = {
        "graveto": { damage: 1, range: 25, color: rgb(139, 69, 19), name: "Graveto Inútil", speed: 0.2 },
        "spectral": { damage: 50, range: 90, color: rgb(0, 255, 255), name: "Lâmina VMZ", speed: 0.05 }
    };

    // 4. Criação do Jogador (Antes do Mapa para evitar ReferenceError)
    const player = add([
        sprite("hero_spectral"),
        pos(150, 150),
        area({ shape: new Rect(vec2(10, 5), 15, 25) }),
        body(),
        anchor("center"),
        setLayer("game"),
        {
            speed: 150,
            weapon: "graveto",
            canDash: true
        },
        "player"
    ]);

    // Visual da arma inicial
    const weaponVisual = player.add([
        rect(2, 10),
        pos(12, 8),
        color(139, 69, 19),
        anchor("bot"),
        rotate(90),
        "weapon_node"
    ]);

    // 5. O Mapa (Agora ele pode "enxergar" o resto do código)
    addLevel([
        "tttttttttttttttttttt",
        "t..................t",
        "t..................t",
        "t.....M............t",
        "t..................t",
        "t...........W......t",
        "t..................t",
        "t......N...........t",
        "t..................t",
        "t...........S......t",
        "tttttttttttttttttttt",
    ], {
        tileWidth: 16,
        tileHeight: 16,
        tiles: {
            ".": () => [ sprite("floor", { frame: ~~rand(0, 8) }), setLayer("bg") ],
            "t": () => [ sprite("wall_top"), area(), body({ isStatic: true }), setLayer("game") ],
            // Marcadores de NPCs
            "M": () => [ "spawn_master" ],
            "N": () => [ "spawn_ninja" ],
            "W": () => [ "spawn_wizard" ],
            "S": () => [ "spawn_enemy" ],
        },
    });

    // 6. Spawning dos NPCs nos lugares marcados
    onAdd("spawn_master", (m) => {
        add([ sprite("old_master"), pos(m.pos), area(), body({isStatic:true}), anchor("center"), "npc", { msg: "O graveto não corta almas. Pegue a Lâmina VMZ!" } ]);
    });
    onAdd("spawn_ninja", (n) => {
        add([ sprite("ninja_green"), pos(n.pos), area(), body({isStatic:true}), anchor("center"), "npc", { msg: "Time Zueira no comando." } ]);
    });
    onAdd("spawn_wizard", (w) => {
        add([ sprite("wizard"), pos(w.pos), area(), body({isStatic:true}), anchor("center"), "npc", { msg: "Cuidado com o Samurai Vermelho!" } ]);
    });
    onAdd("spawn_enemy", (s) => {
        add([ sprite("samurai_red"), pos(s.pos), area(), body(), anchor("center"), health(100), "enemy" ]);
    });

    // 7. Sistema de Combate e Movimento
    function doAttack() {
        const w = weapons[player.weapon];
        shake(2);
        
        // Animação simples
        weaponVisual.angle = player.flipX ? -120 : 120;
        wait(w.speed, () => weaponVisual.angle = 90);

        // Dano
        const enemies = get("enemy");
        enemies.forEach(e => {
            if (player.pos.dist(e.pos) < w.range) {
                e.hurt(w.damage);
                addKaboom(e.pos);
            }
        });
    }

    // Comandos
    onKeyDown("left", () => { player.move(-player.speed, 0); player.flipX = true; weaponVisual.pos = vec2(-12, 8); });
    onKeyDown("right", () => { player.move(player.speed, 0); player.flipX = false; weaponVisual.pos = vec2(12, 8); });
    onKeyDown("up", () => player.move(0, -player.speed));
    onKeyDown("down", () => player.move(0, player.speed));
    
    onKeyPress("space", doAttack);

    // Interação (Tecla E)
    onKeyPress("e", () => {
        get("npc").forEach(npc => {
            if (player.pos.dist(npc.pos) < 40) {
                add([ text(npc.msg, { size: 8, width: 150 }), pos(npc.pos.sub(0, 30)), anchor("center"), lifespan(2), setLayer("ui") ]);
                
                if (npc.msg.includes("VMZ")) {
                    player.weapon = "spectral";
                    weaponVisual.color = rgb(0, 255, 255);
                    weaponVisual.width = 4;
                }
            }
        });
    });

    // 8. Câmera e UI
    player.onUpdate(() => camPos(player.pos));

    add([ sprite("logo_tz"), pos(10, 10), scale(0.05), fixed(), setLayer("ui") ]);
    
    const uiInfo = add([
        text("Arma: Graveto", { size: 10 }),
        pos(40, 15),
        fixed(),
        setLayer("ui")
    ]);

    onUpdate(() => {
        uiInfo.text = "Arma: " + weapons[player.weapon].name;
        uiInfo.color = weapons[player.weapon].color;
    });

    // IA do Inimigo
    onUpdate("enemy", (e) => {
        if (e.pos.dist(player.pos) < 100) {
            e.move(player.pos.sub(e.pos).unit().scale(40));
        }
    });

    on("death", "enemy", (e) => {
        destroy(e);
        add([ text("BOSS DERROTADO", {size: 20}), pos(center()), anchor("center"), fixed() ]);
    });
});

go("game");
</script>
</body>
</html>
