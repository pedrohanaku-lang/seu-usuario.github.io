<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Skul Like Prototype</title>
<style>
html,body { margin:0; background:#000; }
</style>
</head>
<body>

<script src="https://unpkg.com/kaboom/dist/kaboom.js"></script>
<script>
kaboom({
    width: 960,
    height: 540,
    scale: 1,
    background: [20,20,25],
})

/* --------------------------
   PLAYER
---------------------------*/

const player = add([
    rect(24,32),
    color(80,180,255),
    pos(200,300),
    area(),
    body(),
    anchor("center"),
    {
        hp: 100,
    },
    "player"
])

const SPEED = 220

onKeyDown("a",()=>player.move(-SPEED,0))
onKeyDown("d",()=>player.move(SPEED,0))
onKeyDown("w",()=>player.move(0,-SPEED))
onKeyDown("s",()=>player.move(0,SPEED))

/* --------------------------
   ESPADA (igual ao que tu descreveste)
---------------------------*/

let cutting = false

const sword = add([
    rect(8,38),
    color(255,255,255),
    anchor("bot"),
    pos(player.pos),
    rotate(0),
    area({ shape: new Rect(vec2(-4,-38),8,38) }),
    {
        active:false,
    },
    "sword"
])

onMouseDown(() => {
    cutting = true
    sword.active = true
})

onMouseRelease(() => {
    cutting = false
    sword.active = false
})

sword.onUpdate(() => {

    if(!cutting) return

    const dir = mousePos().sub(player.pos)

    const ang = dir.angle()

    sword.pos = player.pos.add(
        dir.unit().scale(26)
    )

    sword.angle = ang
})

/* --------------------------
   CORTE VISUAL
---------------------------*/

function spawnSlash(pos, ang){

    const s = add([
        rect(40,8),
        pos(pos),
        anchor("center"),
        rotate(ang),
        color(255,120,120),
        opacity(0.8),
        lifespan(0.08),
    ])
}

/* --------------------------
   DAMAGE
---------------------------*/

sword.onCollide("enemy", (e) => {
    if(!sword.active) return
    e.hurt(10)
    spawnSlash(sword.pos, sword.angle)
})

sword.onCollide("boss", (b) => {
    if(!sword.active) return
    b.hurt(8)
    spawnSlash(sword.pos, sword.angle)
})

/* --------------------------
   ENEMY FACTORY (MOVESETS)
---------------------------*/

function createEnemy(type, p){

    const enemy = add([
        rect(26,26),
        pos(p),
        anchor("center"),
        area(),
        body(),
        color(255,120,80),
        {
            type,
            hp: type=="brute"?50:30,
            state:"idle",
            timer:0,
        },
        "enemy"
    ])

    enemy.hurt = (d)=>{
        enemy.hp -= d
        if(enemy.hp<=0) destroy(enemy)
    }

    enemy.onUpdate(()=>enemyAI[enemy.type](enemy))

    return enemy
}

/* --------------------------
   MOVESETS (Skul style)
---------------------------*/

const enemyAI = {

    assassin(e){

        e.timer -= dt()

        if(e.state==="idle"){
            if(e.pos.dist(player.pos) < 200){
                e.state="windup"
                e.timer=0.4
            }
        }

        if(e.state==="windup"){
            if(e.timer<=0){
                e.state="dash"
                e.vel = player.pos.sub(e.pos).unit().scale(520)
            }
        }

        if(e.state==="dash"){
            e.move(e.vel)
            if(e.timer<=-0.2){
                e.state="recover"
                e.timer=0.4
            }
        }

        if(e.state==="recover"){
            if(e.timer<=0){
                e.state="idle"
            }
        }

    },

    ranger(e){

        e.timer -= dt()

        if(e.state==="idle"){
            if(e.timer<=0){
                shootEnemyBullet(e)
                e.timer=1.2
            }
        }

    },

    brute(e){

        e.timer -= dt()

        if(e.state==="idle"){
            if(e.pos.dist(player.pos)<120){
                e.state="slam"
                e.timer=0.6
            }
        }

        if(e.state==="slam"){
            if(e.timer<=0){
                spawnShockwave(e.pos)
                e.state="idle"
            }
        }

    }

}

/* --------------------------
   BULLET
---------------------------*/

function shootEnemyBullet(e){

    const dir = player.pos.sub(e.pos).unit()

    add([
        rect(6,6),
        pos(e.pos),
        area(),
        color(255,60,60),
        move(dir,260),
        offscreen({destroy:true}),
        "enemyBullet"
    ])
}

/* --------------------------
   SHOCKWAVE
---------------------------*/

function spawnShockwave(p){

    const w = add([
        circle(12),
        pos(p),
        area(),
        color(255,200,80),
        lifespan(0.3),
        "enemyWave"
    ])
}

/* --------------------------
   BOSS (hitbox do corpo inteiro + fases)
---------------------------*/

const boss = add([
    rect(80,64),
    pos(650,300),
    anchor("center"),
    area(),     // hitbox do corpo inteiro
    body(),
    color(200,60,255),
    {
        hp:300,
        phase:1,
        state:"idle",
        timer:0,
    },
    "boss"
])

boss.hurt = (d)=>{
    boss.hp -= d

    if(boss.hp<=200) boss.phase=2
    if(boss.hp<=100) boss.phase=3

    if(boss.hp<=0){
        destroy(boss)
    }
}

boss.onUpdate(()=>bossAI())

function bossAI(){

    boss.timer -= dt()

    if(boss.phase===1){
        simplePattern()
    }

    if(boss.phase===2){
        dashPattern()
    }

    if(boss.phase===3){
        hellPattern()
    }
}

/* --------------------------
   BOSS PATTERNS
---------------------------*/

function simplePattern(){

    if(boss.timer<=0){
        shootBossRing(6,180)
        boss.timer=2
    }

}

function dashPattern(){

    if(boss.state==="idle"){
        boss.state="dash"
        boss.vel = player.pos.sub(boss.pos).unit().scale(500)
        boss.timer=0.4
    }

    if(boss.state==="dash"){
        boss.move(boss.vel)
        if(boss.timer<=0){
            boss.state="idle"
            boss.timer=1.2
        }
    }

}

function hellPattern(){

    if(boss.timer<=0){
        shootBossRing(14,260)
        boss.timer=1
    }

}

/* --------------------------
   BOSS BULLETS
---------------------------*/

function shootBossRing(n,speed){

    for(let i=0;i<n;i++){

        const a = i*(Math.PI*2/n)
        const dir = vec2(Math.cos(a),Math.sin(a))

        add([
            rect(6,6),
            pos(boss.pos),
            area(),
            color(255,0,200),
            move(dir,speed),
            offscreen({destroy:true}),
            "enemyBullet"
        ])
    }
}

/* --------------------------
   NPC ALIADO QUE ATIRA
---------------------------*/

const ally = add([
    rect(20,20),
    pos(150,380),
    anchor("center"),
    area(),
    color(80,255,120),
    {
        timer:0,
    },
    "ally"
])

ally.onUpdate(()=>{

    ally.timer-=dt()

    if(ally.timer<=0){
        shootAlly()
        ally.timer=0.6
    }

})

function shootAlly(){

    const target = get("enemy")[0] || boss
    if(!target) return

    const dir = target.pos.sub(ally.pos).unit()

    add([
        rect(6,4),
        pos(ally.pos),
        area(),
        color(120,255,120),
        move(dir,420),
        offscreen({destroy:true}),
        "allyBullet"
    ])
}

/* --------------------------
   COLLISIONS
---------------------------*/

onCollide("allyBullet","enemy",(b,e)=>{
    e.hurt(8)
    destroy(b)
})

onCollide("allyBullet","boss",(b,bo)=>{
    bo.hurt(6)
    destroy(b)
})

/* --------------------------
   SPAWN
---------------------------*/

createEnemy("assassin",vec2(400,280))
createEnemy("ranger",vec2(500,200))
createEnemy("brute",vec2(450,360))

/* --------------------------
   CAMERA
---------------------------*/

player.onUpdate(()=>{
    camPos(player.pos)
})

</script>
</body>
</html>
