<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Samurai Roguelike - Fix</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #0f0; background: #050505; display: none; }
        #ui { position: absolute; text-align: center; background: rgba(0,0,0,0.9); padding: 40px; border: 2px solid #0f0; z-index: 100; }
        button { background: transparent; color: #0f0; border: 1px solid #0f0; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; text-transform: uppercase; }
        button:hover { background: #0f0; color: #000; }
        .info { margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>SAMURAI OS v1.0</h1>
        <div class="info">
            [W,A,S,D] MOVER<br>
            [MOUSE 1] ATACAR<br>
            [E] TROCAR ARMA (ESPADA/ARMA)<br>
            [G] EXECUTAR ESPECIAL (QUANDO CHEIO)
        </div>
        <button id="startBtn">INICIALIZAR NÚCLEO</button>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");
const startBtn = document.getElementById("startBtn");

// Estado do Jogo
let gameRunning = false;
let player, enemies, bullets, particles;
let keys = {};
let mouse = { x: 0, y: 0 };
let score = 0, stage = 1, special = 0;

// Inicialização segura
startBtn.addEventListener("click", () => {
    ui.style.display = "none";
    canvas.style.display = "block";
    setup();
    gameRunning = true;
    requestAnimationFrame(gameLoop);
});

window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = e.clientX - rect.left;
    mouse.y = e.clientY - rect.top;
});

canvas.addEventListener("mousedown", () => {
    if (!gameRunning) return;
    if (player.weapon === "gun") fireBullet();
    else swordSlash();
});

function setup() {
    player = {
        x: 400, y: 300, 
        size: 30, speed: 4, 
        hp: 100, weapon: "sword" 
    };
    enemies = [];
    bullets = [];
    particles = [];
    spawnWave();
}

function spawnWave() {
    for (let i = 0; i < 3 + stage; i++) {
        enemies.push({
            x: Math.random() < 0.5 ? -20 : 820,
            y: Math.random() * 600,
            hp: 2 + stage,
            speed: 1 + Math.random(),
            size: 20
        });
    }
}

function fireBullet() {
    const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
    bullets.push({
        x: player.x, y: player.y,
        vx: Math.cos(angle) * 8,
        vy: Math.sin(angle) * 8
    });
}

function swordSlash() {
    const dist = Math.hypot(mouse.x - player.x, mouse.y - player.y);
    if (dist < 120) { // Alcance da espada
        enemies.forEach((en, i) => {
            if (Math.hypot(en.x - mouse.x, en.y - mouse.y) < 50) {
                en.hp -= 3;
                special = Math.min(100, special + 10);
                createParticles(en.x, en.y, "#f00");
            }
        });
    }
}

function createParticles(x, y, color) {
    for (let i = 0; i < 5; i++) {
        particles.push({
            x, y, color,
            vx: (Math.random() - 0.5) * 4,
            vy: (Math.random() - 0.5) * 4,
            life: 1.0
        });
    }
}

function update() {
    // Movimento Player
    if (keys['w'] && player.y > 0) player.y -= player.speed;
    if (keys['s'] && player.y < 600) player.y += player.speed;
    if (keys['a'] && player.x > 0) player.x -= player.speed;
    if (keys['d'] && player.x < 800) player.x += player.speed;

    // Troca de arma
    if (keys['e']) {
        player.weapon = player.weapon === "sword" ? "gun" : "sword";
        keys['e'] = false;
    }

    // Especial
    if (keys['g'] && special >= 100) {
        special = 0;
        enemies = [];
        createParticles(400, 300, "#0f0");
        stage++;
        spawnWave();
    }

    // Balas
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        if (b.x < 0 || b.x > 800 || b.y < 0 || b.y > 600) bullets.splice(i, 1);
        
        enemies.forEach((en, ei) => {
            if (Math.hypot(en.x - b.x, en.y - b.y) < en.size) {
                en.hp--;
                bullets.splice(i, 1);
            }
        });
    });

    // Inimigos
    enemies.forEach((en, i) => {
        const angle = Math.atan2(player.y - en.y, player.x - en.x);
        en.x += Math.cos(angle) * en.speed;
        en.y += Math.sin(angle) * en.speed;

        // Dano no player
        if (Math.hypot(player.x - en.x, player.y - en.y) < 25) {
            player.hp -= 0.2;
            if (player.hp <= 0) location.reload(); // Game Over simples
        }

        if (en.hp <= 0) {
            enemies.splice(i, 1);
            score += 10;
        }
    });

    // Partículas
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy;
        p.life -= 0.02;
        if (p.life <= 0) particles.splice(i, 1);
    });

    if (enemies.length === 0) {
        stage++;
        spawnWave();
    }
}

function draw() {
    ctx.fillStyle = "#050505";
    ctx.fillRect(0, 0, 800, 600);

    // Partículas
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 3, 3);
    });
    ctx.globalAlpha = 1.0;

    // Player
    ctx.fillStyle = "#0f0";
    ctx.fillRect(player.x - 15, player.y - 15, 30, 30);
    
    // Feedback visual da espada
    if (player.weapon === "sword") {
        ctx.strokeStyle = "rgba(0, 255, 0, 0.2)";
        ctx.beginPath();
        ctx.arc(player.x, player.y, 100, 0, Math.PI * 2);
        ctx.stroke();
    }

    // Inimigos
    ctx.fillStyle = "#f00";
    enemies.forEach(en => ctx.fillRect(en.x - 10, en.y - 10, 20, 20));

    // Balas
    ctx.fillStyle = "#ff0";
    bullets.forEach(b => ctx.fillRect(b.x - 2, b.y - 2, 4, 4));

    // UI
    ctx.fillStyle = "#0f0";
    ctx.font = "16px Courier New";
    ctx.fillText(`INTEGRIDADE: ${Math.ceil(player.hp)}%`, 20, 30);
    ctx.fillText(`SCORE: ${score}`, 20, 50);
    ctx.fillText(`FASE: ${stage}`, 20, 70);
    ctx.fillText(`MODO: ${player.weapon.toUpperCase()}`, 20, 90);

    // Barra de Especial
    ctx.strokeStyle = "#0f0";
    ctx.strokeRect(680, 20, 100, 15);
    ctx.fillRect(680, 20, special, 15);
    if (special >= 100) ctx.fillText("ESPECIAL PRONTO [G]", 630, 55);
}

function gameLoop() {
    if (gameRunning) {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
}
</script>
</body>
</html>
