<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Samurai Roguelike Melhorado</title>
<style>
body{margin:0;background:#111;display:flex;justify-content:center;align-items:center;height:100vh;color:#0f0;font-family:Arial, sans-serif;}
canvas{background:#222;border:3px solid #0f0;display:none;position:absolute;z-index:1;}
#menu,#creditos,#cartas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;border:2px solid #0f0;padding:25px;text-align:center;z-index:10;}
#cartas{display:none;gap:15px;}
.cartao{width:160px;border:2px solid #0f0;padding:15px;background:#111;cursor:pointer;}
.cartao:hover{background:#0f0;color:#000;}
button{padding:12px 28px;font-size:18px;cursor:pointer;margin:10px;border:none;background:#0f0;color:#000;}
</style>
</head>
<body>

<canvas id="c" width="800" height="600"></canvas>

<div id="menu">
    <h1>SAMURAI ROGUELIKE</h1>
    <button onclick="startGame()">JOGAR</button><br>
    <button onclick="showCredits()">CRÉDITOS</button>
</div>

<div id="creditos" style="display:none">
    <h2>CRÉDITOS</h2>
    <p>Scripter: Hanako</p>
    <p>Design: Barros</p>
    <button onclick="backMenu()">VOLTAR</button>
</div>

<div id="cartas"></div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const W=800,H=600,PLAYER_SIZE=40;

let player, enemies, playerBullets, enemyBullets;
let keys={}, mouse={x:400,y:300};
let gameActive=false, showingCards=false, gameOverFlag=false;
let stage=1, score=0, kills=0;
let maxLives=5, lives=5;
let doubleShot=false, swordRange=80, swordCooldown=0, shootCooldown=0;
let phase="wave"; 
let weapon="gun"; 
let swordHits=0;

// Barra de ultimate
let specialBar=0;
const maxSpecial=5;

// ---------------- MENU ----------------
function startGame(){
    document.getElementById("menu").style.display="none";
    document.getElementById("creditos").style.display="none";
    canvas.style.display="block";
    ctx.font="16px Arial";
    resetRun();
    gameActive=true;
}
function backMenu(){
    document.getElementById("creditos").style.display="none";
    document.getElementById("menu").style.display="block";
    canvas.style.display="none";
}
function showCredits(){
    document.getElementById("menu").style.display="none";
    document.getElementById("creditos").style.display="block";
}

// ---------------- RESET ----------------
function resetRun(){
    player={x:W/2,y:H/2,speed:5};
    enemies=[]; playerBullets=[]; enemyBullets=[];
    stage=1; score=0; kills=0;
    maxLives=5; lives=5;
    doubleShot=false; swordRange=80;
    swordCooldown=0; shootCooldown=0;
    phase="wave"; gameOverFlag=false; showingCards=false; swordHits=0;
    specialBar=0;
    spawnWave();
}

// ---------------- INPUT ----------------
window.addEventListener("keydown",e=>{
    keys[e.key.toLowerCase()]=true;
    if(e.key.toLowerCase()==="r"&&gameOverFlag){
        canvas.style.display="none";
        document.getElementById("menu").style.display="block";
    }
    if(e.key.toLowerCase()==="e") weapon = (weapon==="gun")?"sword":"gun";
    if(e.key.toLowerCase()==="g" && specialBar>=maxSpecial) activateUltimate();
});
window.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false;});
canvas.oncontextmenu=e=>e.preventDefault();
canvas.addEventListener("mousemove",e=>{
    const r = canvas.getBoundingClientRect();
    mouse.x = e.clientX - r.left;
    mouse.y = e.clientY - r.top;
});
canvas.addEventListener("mousedown",e=>{
    if(e.button===2&&gameActive){
        if(weapon==="gun") shoot();
        else sword();
    }
});

// ---------------- CLASSES ----------------
class Bullet{
    constructor(x,y,tx,ty,s,c){
        this.x=x; this.y=y;
        let dx=tx-x, dy=ty-y;
        let d=Math.hypot(dx,dy)||1;
        this.vx = dx/d*s; this.vy = dy/d*s; this.c=c;
    }
    update(){this.x+=this.vx; this.y+=this.vy;}
    draw(){ctx.fillStyle=this.c; ctx.fillRect(this.x-4,this.y-4,8,8);}
    off(){return this.x<-20||this.x>W+20||this.y<-20||this.y>H+20;}
}

// ---------------- PLAYER ----------------
function drawPlayer(){
    ctx.fillStyle="#0f0";
    ctx.fillRect(player.x,player.y,PLAYER_SIZE,PLAYER_SIZE);
    ctx.fillStyle="#000";
    ctx.fillRect(player.x+10,player.y+10,5,5);
    ctx.fillRect(player.x+25,player.y+10,5,5);
}

// ---------------- ESPADA ----------------
let swordAttack = { active:false, x:0, y:0, tx:0, ty:0, length:80, damage:1, destroyBulletChance:0.3 };

function sword(){
    if(swordCooldown>0) return;
    swordCooldown=15;
    swordHits++;
    swordAttack.active=true;
    swordAttack.x=player.x+PLAYER_SIZE/2;
    swordAttack.y=player.y+PLAYER_SIZE/2;
    swordAttack.tx=mouse.x;
    swordAttack.ty=mouse.y;

    // chance de destruir balas
    for(let i=enemyBullets.length-1;i>=0;i--){
        let b=enemyBullets[i];
        let d=Math.hypot(b.x-swordAttack.x, b.y-swordAttack.y);
        if(d<swordAttack.length && Math.random()<swordAttack.destroyBulletChance){
            enemyBullets.splice(i,1);
            specialBar=Math.min(maxSpecial,specialBar+1); // carregar ultimate com balas
        }
    }

    // dano nos inimigos
    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i];
        let dx=(e.x+e.w/2)-swordAttack.x;
        let dy=(e.y+e.h/2)-swordAttack.y;
        let d=Math.hypot(dx,dy);
        if(d<swordAttack.length){
            hitEnemy(i);
            if(Math.random()<0.3) hitEnemy(i);
        }
    }
}

function drawSword(){
    if(!swordAttack.active) return;
    ctx.strokeStyle="#ff0";
    ctx.lineWidth=4;
    let dx=swordAttack.tx-swordAttack.x;
    let dy=swordAttack.ty-swordAttack.y;
    let dist=Math.hypot(dx,dy);
    let ex=swordAttack.x + dx/dist * swordAttack.length;
    let ey=swordAttack.y + dy/dist * swordAttack.length;
    ctx.beginPath();
    ctx.moveTo(swordAttack.x,swordAttack.y);
    ctx.lineTo(ex,ey);
    ctx.stroke();
    swordAttack.active=false;
}

// ---------------- ULTIMATE ----------------
function activateUltimate(){
    for(let i=enemies.length-1;i>=0;i--) hitEnemy(i);
    enemyBullets=[];
    specialBar=0;
    ctx.strokeStyle="#ff0";
    ctx.lineWidth=12;
    ctx.beginPath();
    ctx.moveTo(0,H/2);
    ctx.lineTo(W,H/2);
    ctx.stroke();
}

// ---------------- TIROS ----------------
function shoot(){
    if(shootCooldown>0) return;
    fireBullet();
    if(doubleShot) setTimeout(fireBullet,60);
    shootCooldown=15;
}
function fireBullet(){
    playerBullets.push(new Bullet(player.x+PLAYER_SIZE/2,player.y+PLAYER_SIZE/2,mouse.x,mouse.y,8,"#f44"));
}

// ---------------- SPAWN ----------------
function spawnEnemy(type="normal"){
    let enemy={x:Math.random()*(W-28),y:Math.random()*(H-28),w:28,h:28,
               vx:Math.random()*1.5-0.75,vy:Math.random()*1.5-0.75,
               shootTimer:0, shootInterval:type==="normal"?100:0,
               hp:type==="normal"?3:5,type:type};
    enemies.push(enemy);
}

function spawnBoss(){
    enemies.push({x:W/2-100,y:40,w:200,h:200,vx:1.2,vy:1.2,
                  shootTimer:0, shootInterval:50,
                  isBoss:true,maxHp:250+stage*50,hp:250+stage*50,
                  patternTimer:0});
    phase="boss";
}

function spawnWave(){
    phase="wave";
    for(let i=0;i<2+stage;i++) spawnEnemy("normal");
}

// ---------------- HIT / KILL ----------------
function hitEnemy(i){
    let e=enemies[i];
    e.hp--;
    if(e.hp<=0) killEnemy(i);
}

function killEnemy(i){
    let e=enemies.splice(i,1)[0];
    kills++;
    if(!e.isBoss){
        score+=10;
        if(phase==="wave"&&enemies.length===0) showShop();
        return;
    }
    openCards();
    setTimeout(()=>{stage++; spawnWave();},200);
}

// ---------------- SHOP ----------------
function showShop(){
    showingCards=true; gameActive=false;
    const div=document.getElementById("cartas");
    div.innerHTML=""; div.style.display="flex";
    const pool=[
        {t:"+1 vida máxima", f:()=>{maxLives++; lives++;}},
        {t:"Tiro duplo", f:()=>{doubleShot=true;}},
        {t:"Espada maior", f:()=>{swordRange+=40;}},
        {t:"Velocidade +", f:()=>{player.speed+=1;}},
        {t:"Reduz cooldown espada", f:()=>{swordCooldown=Math.max(5,swordCooldown-5);}}
    ];
    shuffle(pool);
    for(let i=0;i<3;i++){
        let c=document.createElement("div");
        c.className="cartao"; c.textContent=pool[i].t;
        c.onclick=()=>{ pool[i].f(); div.style.display="none"; showingCards=false; gameActive=true; spawnBoss(); };
        div.appendChild(c);
    }
}

function openCards(){showShop();}
function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];}}

// ---------------- UPDATE ----------------
function update(){
    if(!gameActive) return;
    if(shootCooldown>0) shootCooldown--;
    if(swordCooldown>0) swordCooldown--;
    if((keys[" "]||keys["space"])&&weapon==="sword"&&swordCooldown===0) sword();

    if(keys["w"]||keys["arrowup"]) player.y-=player.speed;
    if(keys["s"]||keys["arrowdown"]) player.y+=player.speed;
    if(keys["a"]||keys["arrowleft"]) player.x-=player.speed;
    if(keys["d"]||keys["arrowright"]) player.x+=player.speed;
    player.x=Math.max(0,Math.min(W-PLAYER_SIZE,player.x));
    player.y=Math.max(0,Math.min(H-PLAYER_SIZE,player.y));

    enemies.forEach(e=>{
        e.x+=e.vx; e.y+=e.vy;
        if(e.x<0||e.x+e.w>W) e.vx*=-1;
        if(e.y<0||e.y+e.h>H) e.vy*=-1;
    });

    updateBullets(playerBullets,true);
    updateBullets(enemyBullets,false);
}

function updateBullets(arr,isPlayer){
    for(let i=arr.length-1;i>=0;i--){
        let b=arr[i]; b.update();
        if(b.off()){arr.splice(i,1); continue;}
        if(!isPlayer){
            let d=Math.hypot(b.x-(player.x+PLAYER_SIZE/2), b.y-(player.y+PLAYER_SIZE/2));
            if(d<14){ arr.splice(i,1); lives--; if(lives<=0) gameOver(); specialBar=Math.min(maxSpecial,specialBar+1); }
        }else{
            for(let j=enemies.length-1;j>=0;j--){
                let e=enemies[j];
                let dx = (e.x+e.w/2)-b.x;
                let dy = (e.y+e.h/2)-b.y;
                let d=Math.hypot(dx,dy);
                if(d<18){ arr.splice(i,1); hitEnemy(j); break; }
            }
        }
    }
}

function gameOver(){gameActive=false; gameOverFlag=true;}

// ---------------- DRAW ----------------
function draw(){
    ctx.clearRect(0,0,W,H);
    drawPlayer();
    drawSword();

    enemies.forEach(e=>{
        ctx.fillStyle=e.isBoss?"#600":e.type==="dasher"?"#f33":"#f0f";
        ctx.fillRect(e.x,e.y,e.w,e.h);
        if(e.isBoss){
            let bw=e.w*(e.hp/e.maxHp);
            ctx.fillStyle="#fff"; ctx.fillRect(e.x,e.y-10,e.w,6);
            ctx.fillStyle="red"; ctx.fillRect(e.x,e.y-10,bw,6);
        }
    });

    playerBullets.forEach(b=>b.draw());
    enemyBullets.forEach(b=>b.draw());

    ctx.fillStyle="#0f0";
    ctx.fillText("Fase: "+stage,10,18);
    ctx.fillText("Vidas: "+lives+"/"+maxLives,10,34);
    ctx.fillText("Kills: "+kills,10,50);
    ctx.fillText("Score: "+score,10,66);
    ctx.fillText("Arma: "+(weapon==="gun"?"Tiro":"Espada"),10,82);

    // barra ultimate
    ctx.strokeStyle="#ff0";
    ctx.strokeRect(W-120,H-30,100,10);
    ctx.fillStyle="#ff0";
    ctx.fillRect(W-120,H-30,100*(specialBar/maxSpecial),10);

    if(gameOverFlag){
        ctx.fillStyle="rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle="red";
        ctx.font="40px Arial";
        ctx.fillText("GAME OVER",W/2-120,H/2);
        ctx.font="18px Arial";
        ctx.fillText("Pressione R para voltar ao menu",W/2-150,H/2+30);
    }
}

// ---------------- LOOP ----------------
function loop(){requestAnimationFrame(loop); update(); draw();}
loop();
</script>
</body>
</html>
